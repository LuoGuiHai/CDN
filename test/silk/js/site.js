"use strict";function _typeof(t){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}(function(){var r,n,o,u,s,e,v,O,t,l=function(t,e){return function(){return t.apply(e,arguments)}},h={}.hasOwnProperty,M=[].slice;window._d=window.d=null!=(t="undefined"!=typeof console&&null!==console?console.log.bind(console):void 0)?t:function(){},_.mixin({touch:function(t,e){var i;return null==e&&(e=!1),(i=null)!=t.originalEvent&&null!=t.originalEvent.touches&&(i=t.originalEvent.touches[0]||t.originalEvent.changedTouches[0]),null!=i?(e&&t.originalEvent.preventDefault(),i):t},save:function(t,e){e=JSON.stringify({contents:e});try{return localStorage.setItem(t,e)}catch(t){t}},load:function(t,e){var i;try{i=localStorage.getItem(t)}catch(t){return t,e}return null!==i?JSON.parse(i).contents:e},lerp:function(t,e,i){return t+(e-t)*i},unlerp:function(t,e,i){return t===e?i:(i-t)/(e-t)},constrain:function(t,e,i){return i<t?i:t<e?e:t},rto:function(t){return Math.random()*t},hexToRGB:function(t){var e,i,n,r;for(i=/^#?([a-f0-9]{2})([a-f0-9]{2})([a-f0-9]{2})$/i.exec(t).slice(1),r=[],e=n=0;n<=2;e=++n)r.push(parseInt(i[e],16));return r}}),r=function(){function t(t,e){this.canvas=t,this.fullscreen=null==e||e,this.resizeToWindowAndPreserveContents=l(this.resizeToWindowAndPreserveContents,this),this.fullscreen?(this.resizeToWindow(),$(window).resize(_.debounce(this.resizeToWindowAndPreserveContents,300))):(this.updateSizeOnScreen(this.canvas.width,this.canvas.height),this.transformAndResizeForHighDPI())}return t.prototype.updateSizeOnScreen=function(t,e){return this.widthOnScreen=t,this.halfWidthOnScreen=this.widthOnScreen/2,this.heightOnScreen=e,this.halfHeightOnScreen=this.heightOnScreen/2},t.prototype.transformAndResizeForHighDPI=function(){var t,e,i;if(!MobileDetect())return e=this.canvas.getContext("2d"),i=window.devicePixelRatio||1,t=e.webkitBackingStorePixelRatio||e.mozBackingStorePixelRatio||e.msBackingStorePixelRatio||e.oBackingStorePixelRatio||e.backingStorePixelRatio||1,this.scaleRatio=i/t,1!==this.scaleRatio?(this.canvas.width=this.widthOnScreen*this.scaleRatio,this.canvas.height=this.heightOnScreen*this.scaleRatio,this.canvas.style.width=this.widthOnScreen+"px",this.canvas.style.height=this.heightOnScreen+"px",e.scale(this.scaleRatio,this.scaleRatio)):void 0},t.prototype.resizeToWindow=function(){return this.resizeCanvas(window.innerWidth,window.innerHeight)},t.prototype.resizeCanvas=function(t,e){return this.canvas.width=t,this.canvas.height=e,this.updateSizeOnScreen(t,e),this.transformAndResizeForHighDPI()},t.prototype.resizeToWindowAndPreserveContents=function(){var t,e,i,n;return n=this.canvas.width,i=this.canvas.height,e=this.canvas.getContext("2d").getImageData(0,0,n-1,i-1),this.resizeToWindow(),(t=this.canvas.getContext("2d")).fillStyle="#000",t.fillRect(0,0,this.canvas.width,this.canvas.height),t.putImageData(e,(this.canvas.width-n)/2,(this.canvas.height-i)/2)},t}(),u=function(){function a(t,e,i){this.ctx=t,this.scaleInfo=e,null==i&&(i={}),this.drawCurve=l(this.drawCurve,this),this.drawInstruction=l(this.drawInstruction,this),i=$.extend(!0,{},i),$.extend(this,a.initialState,i),null==this.originalLogicalWidth&&(this.originalLogicalWidth=this.scaleInfo.logicalWidth),null==this.originalLogicalHeight&&(this.originalLogicalHeight=this.scaleInfo.logicalHeight),this.drawScale=Math.min(this.scaleInfo.logicalWidth/this.originalLogicalWidth,this.scaleInfo.logicalHeight/this.originalLogicalHeight,1),this.offsetX=(this.scaleInfo.logicalWidth-this.originalLogicalWidth)/2,this.offsetY=(this.scaleInfo.logicalHeight-this.originalLogicalHeight)/2,null==this.curve&&(this.curve=[]),this.initColors(),this.cx=this.symCenterX,this.cy=this.symCenterY,this.twoCx=2*this.cx,this.twoCy=2*this.cy,this.generateDrawInstructions()}return a.prototype.initColors=function(){var t;switch(this.highlightMode){case"time":this.colorScale=d3.scale.linear().domain([this.timeColorScaleDomainLow,this.timeColorScaleDomainHigh]).range([this.highlightColor,this.color]);break;case"velocity":this.colorScale=d3.scale.pow().exponent(this.velocityColorScaleExponent).domain([this.velocityColorScaleDomainLow,this.velocityColorScaleDomainHigh]).range([this.color,this.highlightColor])}return this.colorScale.clamp(!0),this.colorScale.interpolate(d3.interpolateHcl),this.isEraser=this.color===(t=this.highlightColor)&&t===this.eraserColor},a.prototype.frame=function(){var t,e,i;for(this.frameTime++,i=[],t=1,e=this.drawsPerFrame;1<=e?t<=e:e<=t;1<=e?++t:--t)i.push(this.step(!0));return i},a.prototype.step=function(t){var e,i,n,r,o,s,a,l,u,h,c,p,d,f,g,v,m,y;if(null==t&&(t=!0),!this.startDrawingOnceCompleted||this.completed){for(n=this.curve,this.timeColorScaleTime++,this.time++;n.length&&0===n[0].life;)n.shift();for(l=m=0,y=n.length;m<y;l=++m)c=n[l],e=i=0,this.rotateAnglesAroundSymmetryAxis&&(d=Math.atan2(this.cx-c.y,this.cy-c.x)),this.noiseForceScale&&(h=noise(this.noiseOffset+c.x*this.noiseSpaceScale+1e6,this.noiseOffset+c.y*this.noiseSpaceScale+1e6,this.noiseOffset+this.noiseTimeScale*this.time,this.noiseOctaves,this.noiseFallout),u=this.noiseAngleOffset+this.noiseAngleScale*h,this.rotateAnglesAroundSymmetryAxis&&(u+=d),e+=this.noiseForceScale*Math.cos(u),i+=this.noiseForceScale*Math.sin(u)),this.initialVelocityForceScale&&(e+=this.initialVelocityForceScale*c.inputVx,i+=this.initialVelocityForceScale*c.inputVy,c.inputVx&&c.inputVy&&(c.inputVx*=this.initialVelocityDecay,c.inputVy*=this.initialVelocityDecay)),0<this.windForceScale&&(f=this.windAngle,this.rotateAnglesAroundSymmetryAxis&&(f+=d),e+=this.windForceScale*Math.cos(f),i+=this.windForceScale*Math.sin(f)),c.x+=(c.x-c.px)*this.friction+e,c.y+=(c.y-c.py)*this.friction+i,c.px=c.x,c.py=c.y,c.life--,l&&(g=(p=n[l-1]).x-c.x,v=p.y-c.y,(o=Math.sqrt(g*g+v*v))>this.restingDistance+.01&&(s=(r=this.rigidity*(this.restingDistance-o)/o)*g,a=r*v,c.x-=s,p.x+=s,c.y-=a,p.y+=a));return t?this.draw():void 0}},a.prototype.generateDrawInstructions=function(){var n,r,t,o,s,a,l,e,i,u;for(this.drawInstructions=[],this.cx,this.cy,t=2*Math.PI/this.symNumRotations,l=d3.scale.pow().exponent(.5).domain([0,1]).range([1,0]),u=[],s=e=0,i=this.symNumRotations;e<i;s=e+=1)o=s*t,u.push(function(){var t,e,i;for(i=[],a=t=0,e=this.spiralCopies;t<e;a=t+=1)r=(a=a+.25-.25)/this.spiralCopies,n={rotationIndex:s,spiralIndex:a,cos:Math.cos(o+this.spiralAngle*r),sin:Math.sin(o+this.spiralAngle*r),scale:l(r)*this.brushScale,original:0===s&&0===a},this.drawInstructions.push(n),this.symMirror?i.push(this.drawInstructions.push(_.extend({},n,{mirror:!0}))):i.push(void 0);return i}.call(this));return u},a.prototype.draw=function(){var t,e,i,n,r,o,s,a,l,u;for(t=this.curve,this.setColor(),n=0,s=t.length;n<s;n++)(i=t[n]).__x__=i.x,i.__y__=i.y;for(r=0,a=(u=this.drawInstructions).length;r<a;r++)e=u[r],this.drawInstruction(e);for(o=0,l=t.length;o<l;o++)(i=t[o]).x=i.__x__,i.y=i.__y__},a.prototype.drawInstruction=function(t){var e,i,n,r,o,s;for(e=this.curve,this.cx,this.cy,this.scaleLineWidth&&(this.ctx.lineWidth=t.scale),o=0,s=e.length;o<s;o++)n=(i=e[o]).__x__-this.cx,r=i.__y__-this.cy,i.x=(n*t.cos-r*t.sin)*t.scale,i.y=(n*t.sin+r*t.cos)*t.scale,t.mirror&&(i.x=-i.x),i.x*=this.drawScale,i.y*=this.drawScale,i.x+=this.cx,i.y+=this.cy,i.x+=this.offsetX,i.y+=this.offsetY;return this.drawCurve(t)},a.prototype.drawCurve=function(t){var e,i,n,r,o,s,a,l;if(i=this.curve,e=this.ctx,this.twoCx,i.length){for(r=i.length-1,t.original&&this.frameTime%10==0&&this.sparkleLine(),e.beginPath(),e.moveTo(i[0].x,i[0].y),o=i[1],n=a=1,l=r-1;a<l;n=a+=1)s=i[n+1],e.quadraticCurveTo(o.x,o.y,(o.x+s.x)/2,(o.y+s.y)/2),o=s;e.stroke()}},a.prototype.addPoint=function(t,e,i,n){this.completed||(this.curve[this.curve.length]={px:t,py:e,x:t,y:e,inputVx:i,inputVy:n,life:this.startLife})},a.prototype.complete=function(){if(this.completed=!0,this.stopDrawingOnceCompleted)return this.curve=[]},a.prototype.finish=function(){return this.complete(),this.curve=[]},a.prototype.isFinishedDrawing=function(){return this.completed&&(0===this.curve.length||this.stopDrawingOnceCompleted)},a.prototype.setColor=function(){var t;if(this.curve.length)return this.ctx.globalCompositeOperation=this.isEraser?"source-over":this.compositeOperation,t=this.curve[this.curve.length-1],this.ctx.globalAlpha=this.startOpacity*(t.life/this.startLife),this.ctx.strokeStyle=this.colorScale(function(){switch(this.highlightMode){case"time":return this.timeColorScaleTime;case"velocity":return Math.sqrt(t.inputVx*t.inputVx+t.inputVy*t.inputVy)}}.call(this))},a.prototype.setSparks=function(t){return this.sparks=t,this.sparkle=!0},a.prototype.sparkleLine=function(){var t;if(t=this.curve.length)return this.sparklePoint(this.curve[_.random(t-1)])},a.prototype.sparklePoint=function(t){var e,i;if(this.sparkle)return i=.8*t.life/this.startLife,e=d3.rgb(this.ctx.strokeStyle).brighter(2).toString(),this.sparks.add(t.x,t.y,{a:i,color:e})},a.prototype.serialize=function(){var t,e,i,n,r,o,s;for(n=0,r=(o=this.curve).length;n<r;n++)delete(i=o[n]).__x__,delete i.__y__;for(e in t={},s=a.initialState)h.call(s,e)&&(s[e],t[e]=this[e]);return t.curve=$.extend(!0,[],this.curve),t},a.initialState={type:"silk",version:1,time:0,frameTime:0,completed:!1,startDrawingOnceCompleted:!1,stopDrawingOnceCompleted:!1,brushScale:1,scaleLineWidth:!0,startLife:150,startOpacity:.09,color:"#276f9b",highlightColor:"#276f9b",highlightMode:"velocity",eraserColor:"#000000",velocityColorScaleExponent:1.5,velocityColorScaleDomainLow:10,velocityColorScaleDomainHigh:30,timeColorScaleDomainLow:0,timeColorScaleDomainHigh:350,timeColorScaleTime:0,compositeOperation:"lighter",noiseForceScale:1,noiseSpaceScale:.02,noiseTimeScale:.005,noiseOffset:0,noiseOctaves:8,noiseFallout:.65,noiseAngleScale:5*Math.PI,noiseAngleOffset:0,initialVelocityForceScale:.3,initialVelocityDecay:.98,windForceScale:0,windAngle:Math.PI,rotateAnglesAroundSymmetryAxis:!0,friction:.975,restingDistance:0,rigidity:.2,symType:"point",symNumRotations:1,symMirror:!0,symCenter:"centerScreen",symCenterX:0,symCenterY:0,spiralCopies:1,spiralAngle:.75*Math.PI,curve:null,originalLogicalWidth:null,originalLogicalHeight:null,drawsPerFrame:5},a}(),n=function(t){function n(t,e,i){switch(this.ctx=t,this.scaleInfo=e,null==i&&(i={}),this.drawCurve=l(this.drawCurve,this),n.__super__.constructor.apply(this,arguments),null==this.previewRadius&&(this.previewRadius=4),null==this.previewOpacity&&(this.previewOpacity=1),null==this.targetOpacity&&(this.targetOpacity=1),null==this.visible&&(this.visible=!0),this.previewEmphasis){case"spiral":this.previewEmphasisFn=function(t){return 0<t.spiralIndex};break;case"rotation":this.previewEmphasisFn=function(t){return 0===t.spiralIndex&&!t.mirror};break;case"mirror":this.previewEmphasisFn=function(t){return t.mirror}}(function(){switch(this.hightlightMode){case"time":return this.highlightColor;case"velocity":return this.color}}).call(this)}return function(t,e){for(var i in e)h.call(e,i)&&(t[i]=e[i]);function n(){this.constructor=t}n.prototype=e.prototype,t.prototype=new n,t.__super__=e.prototype}(n,u),n.prototype.frame=function(){if(this.curve.length){switch(!1){case!(this.previewOpacity>this.targetOpacity):this.previewOpacity-=.05,this.previewOpacity<this.targetOpacity&&(this.previewOpacity=this.targetOpacity);break;case!(this.previewOpacity<this.targetOpacity):this.previewOpacity+=.05,this.previewOpacity>this.targetOpacity&&(this.previewOpacity=this.targetOpacity)}return this.completed&&0===this.previewOpacity?this.finish():this.visible?this.draw():void 0}},n.prototype.setVisible=function(t){this.visible=t},n.prototype.setTargetOpacity=function(t){this.targetOpacity=t},n.prototype.fadeIn=function(){return this.targetOpacity=1},n.prototype.fadeOut=function(){return this.targetOpacity=0},n.prototype.fadeInFromZero=function(){return this.previewOpacity=0,this.targetOpacity=1},n.prototype.fadeOutFromOne=function(){return this.previewOpacity=1,this.targetOpacity=0},n.prototype.completeAndFadeOut=function(){return this.complete(),this.fadeOut()},n.prototype.drawCurve=function(t){var e,i;return i=this.curve[0],this.ctx.beginPath(),e=this.ctx.fillStyle,this.ctx.fillStyle="#4e4866",("function"==typeof this.previewEmphasisFn?this.previewEmphasisFn(t):void 0)&&(this.ctx.fillStyle="#ffffff"),this.ctx.arc(i.x,i.y,t.scale*this.previewRadius,0,2*Math.PI,!1),this.ctx.fill(),this.ctx.fillStyle=e,this.ctx.globalCompositeOperation="source-over",this.ctx.strokeWidth=.5,this.ctx.stroke(),this.ctx.closePath()},n.prototype.addPoint=function(t,e,i,n){if(!this.completed)return this.curve=[{x:t,y:e}]},n.prototype.setColor=function(){return this.ctx.globalAlpha=this.previewOpacity,this.ctx.globalCompositeOperation=this.globalCompositeOperation},n.prototype.serialize=function(){var t;return(t=n.__super__.serialize.call(this)).curve=[],t},n}(),this.Silks=function(){function t(t,e,i,n){this.container=t,this.silkCanvas=e,this.bufferCanvas=i,this.sparksCanvas=n,this.replayReplay=l(this.replayReplay,this),this.undo=l(this.undo,this),this.clear=l(this.clear,this),this.all={},this.sparks=new s(this.sparksCanvas),this.recorder=new o(this),this.silkCtx=this.silkCanvas.getContext("2d"),this.sparksCtx=this.sparksCanvas.getContext("2d"),this.sparksCanvas._util=new r(this.sparksCanvas),this.bufferCanvas._util=new r(this.bufferCanvas),this.silkCanvas._util=new r(this.silkCanvas),this.backgroundColor="#000",this.snapshotState={justCleared:ko.observable(!0),canUndo:ko.observable(!1)},this.previewSilks={},this.inputPreviewSilk=null,this.inputPreviewSilkId=null,this.nextUndoIsRedo=ko.observable(!1),this.undoSnapshot=null,this.clearUndoSnapshot=null,this.silkSettingsState=$.extend(!0,{},u.initialState),this.fillSilkCanvas(),this.drawInputPreview=!0,this.frameTime=0}return t.prototype.scaleInfo=function(){return{logicalWidth:this.silkCanvas._util.widthOnScreen,logicalHeight:this.silkCanvas._util.heightOnScreen}},t.prototype.frame=function(t){var e,i,n,r,o;for(e in this.frameTime++,this.recorder.frame(),this.trackingInput&&this.inputFrame(),n=this.all)(i=n[e]).frame(),i.isFinishedDrawing()&&delete this.all[e];for(e in this.allSilksCompleted()&&this.recorder.stopRecording(),this.sparks.frame(t),o=[],r=this.previewSilks)i=r[e],!1===this.drawInputPreview&&e===this.inputPreviewSilkId||i.frame(),i.isFinishedDrawing()?o.push(delete this.previewSilks[e]):o.push(void 0);return o},t.prototype.randomId=function(){return Math.round(9999999999*Math.random())+""},t.prototype.extendSilkSettingsState=function(t){return $.extend(this.silkSettingsState,t)},t.prototype.silkStartState=function(){var t;return"centerScreen"===(t=$.extend(!0,{},this.silkSettingsState)).symCenter&&$.extend(t,{symCenterX:this.silkCanvas._util.halfWidthOnScreen,symCenterY:this.silkCanvas._util.halfHeightOnScreen}),t},t.prototype.add=function(t,e){var i,n,r;return this.undoSnapshot=this.takeSnapshot(),this.clearUndoSnapshot=null,this.nextUndoIsRedo(!1),this.snapshotState.justCleared(!1),this.recorder.startRecording(),null==t&&(t=this.randomId()),n=this.scaleInfo(),(r=null!=e?new u(this.silkCtx,n,e):null!=this.inputPreviewSilkId?new u(this.silkCtx,n,this.inputPreviewSilk.serialize()):new u(this.silkCtx,n,this.silkStartState())).setSparks(this.sparks),"undefined"!=typeof Hue&&null!==Hue&&(i=d3.hsl(r.color),d("color:",i),Hue.setBri(3,parseInt(255*i.l)),d(i.h,i.s,i.l),d(Hue.setHueSat(3,parseInt(i.h/360*65536),parseInt(255*i.s)))),this.recorder.rec("add",t,r.serialize()),this.all[t]=r,t},t.prototype.addPreviewSilk=function(t){var e,i;return e=this.randomId(),i=this.silkStartState(),null!=t&&$.extend(i,t),this.previewSilks[e]=new n(this.sparksCtx,this.scaleInfo(),i),e},t.prototype.getPreviewSilk=function(t){return this.previewSilks[t]},t.prototype.removePreviewSilk=function(t){return delete this.previewSilks[t]},t.prototype.nextInputPreviewSilk=function(){return null!=this.inputPreviewSilkId&&this.inputPreviewSilk.completeAndFadeOut(),this.inputPreviewSilkId=this.addPreviewSilk(),this.inputPreviewSilk=this.previewSilks[this.inputPreviewSilkId],this.inputPreviewSilk.fadeInFromZero()},t.prototype.addPoint=function(t,e,i,n,r,o){if(o||this.scaleInfo(),this.recorder.rec("addPoint",t,e,i,n,r,!0),t in this.all)return this.all[t].addPoint(e,i,n,r)},t.prototype.complete=function(t){if(t in this.all)return this.all[t].complete(),this.recorder.rec("complete",t)},t.prototype.allSilksCompleted=function(){var t,e;for(t in e=this.all)if(!e[t].completed)return!1;return!0},t.prototype.clear=function(t){var e;for(e in null==t&&(t=!0),this.snapshotState.justCleared()||(this.clearUndoSnapshot=this.takeSnapshot(),this.clearUndoSnapshot.nextUndoIsRedo=this.nextUndoIsRedo(),this.nextUndoIsRedo(!1),this.snapshotState.justCleared(!0),this.recorder.stopRecording(),this.recorder.ejectAll()),this.all)this.complete(e);if(this.all={},this.swapSilkCanvii(),t)return this.addParticles()},t.prototype.addParticles=function(t,e){var i,n,r,o,s,a,l,u,h,c;for(null==t&&(t=1),null==e&&(e=100),a=(s=this.silkCanvas._util.widthOnScreen)/2,r=(n=this.silkCanvas._util.heightOnScreen)/2,o=.25*t,c=[],h=1;1<=e?h<=e:e<=h;1<=e?++h:--h)l=_.random(s),u=_.random(n),i=Math.atan2(u-r,l-a),c.push(this.sparks.add(l,u,{a:1,color:"#ffffff",vx:o*Math.cos(i),vy:o*Math.sin(i),lifespan:25+_.random(60)}));return c},t.prototype.swapSilkCanvii=function(){var t,e;return t=[this.bufferCanvas,this.silkCanvas],this.silkCanvas=t[0],this.bufferCanvas=t[1],this.silkCtx=this.silkCanvas.getContext("2d"),$(this.silkCanvas).removeClass("buffer onepacity").addClass("active zeropacity").insertBefore($(this.bufferCanvas)),$(this.bufferCanvas).removeClass("active").addClass("buffer onepacity"),this.fillSilkCanvas(),_.defer((e=this,function(){return $(e.silkCanvas).removeClass("zeropacity")}))},t.prototype.fillCanvas=function(t,e){var i;return(i=t.getContext("2d")).globalCompositeOperation="source-over",i.globalAlpha=1,""===(i.fillStyle=e)||"transparent"===e?i.clearRect(0,0,i.canvas.width,i.canvas.height):i.fillRect(0,0,i.canvas.width,i.canvas.height)},t.prototype.clearSilkCanvas=function(){return this.fillCanvas(this.silkCanvas,"transparent")},t.prototype.fillSilkCanvas=function(t){return null==t&&(t=this.backgroundColor),this.fillCanvas(this.silkCanvas,t)},t.prototype.nextSnapshotCanvas=function(){var e,i,t;for(e=[],i=t=1;t<=4;i=++t)e.push(document.createElement("canvas"));return i=0,function(){var t;return t=e[i],i=(i+1)%e.length,t}}(),t.prototype.takeSnapshot=function(){var t,e,i,n,r,o,s,a,l,u;for(r in(n=this.nextSnapshotCanvas()).width=this.silkCanvas.width,n.height=this.silkCanvas.height,n.getContext("2d").drawImage(this.silkCanvas,0,0,n.width,n.height),t={},l=this.all)a=l[r],t[r]=a.serialize();for(o in s=this.recorder.serialize(),i={},u=this.snapshotState)e=u[o],i[o]=e();return{all:t,canvas:n,recorder:s,sizeOnScreen:{width:this.silkCanvas._util.widthOnScreen,height:this.silkCanvas._util.heightOnScreen},bindingValues:i}},t.prototype.loadSnapshot=function(t){var e,i,n,r,o,s,a,l;for(e in this.silkCtx.globalAlpha=1,this.fillSilkCanvas(),this.silkCtx.drawImage(t.canvas,(this.silkCanvas._util.widthOnScreen-t.sizeOnScreen.width)/2,(this.silkCanvas._util.heightOnScreen-t.sizeOnScreen.height)/2,t.sizeOnScreen.width,t.sizeOnScreen.height),this.all={},n=this.scaleInfo(),s=t.all)r=s[e],this.all[e]=new u(this.silkCtx,n,r);for(i in this.recorder.unserialize(t.recorder),l=[],a=t.bindingValues)o=a[i],l.push(this.snapshotState[i](o));return l},t.prototype.undo=function(){var t;switch(!1){case null==this.clearUndoSnapshot:return this.swapSilkCanvii(),this.loadSnapshot(this.clearUndoSnapshot),this.nextUndoIsRedo(this.clearUndoSnapshot.nextUndoIsRedo),this.clearUndoSnapshot=null,this.addParticles(-1);case null==this.undoSnapshot:return t=this.takeSnapshot(),this.swapSilkCanvii(),this.loadSnapshot(this.undoSnapshot),this.nextUndoIsRedo()?this.addParticles():this.addParticles(-1),this.nextUndoIsRedo(!this.nextUndoIsRedo()),this.undoSnapshot=t}},t.prototype.replayReplay=function(){var t;return t=this.recorder.ejectAll(),this.clear(!1),this.recorder.play(t)},t.prototype.getReplay=function(){return this.recorder.get()},t.prototype.playReplay=function(t){return this.recorder.play(t)},t.prototype.makeThumb=function(){var t,e,i,n,r;return 300,(t=document.createElement("canvas")).width=t.height=300,n=i=300,(r=this.silkCanvas.width/this.silkCanvas.height)<1?i*=r:n*=r,(e=t.getContext("2d")).fillStyle=this.backgroundColor,e.fillRect(0,0,t.width,t.height),e.imageSmoothingEnabled=e.webkitImageSmoothingEnabled=e.mozImageSmoothingEnabled=!0,e.drawImage(this.silkCanvas,(300-n)/2,(300-i)/2,n,i),t.toDataURL("image/png").replace(/^data:image\/\w+;base64,/,"")},t.prototype.getImageUrl=function(){return this.silkCanvas.toDataURL("image/png")},t.prototype.inputFrame=function(){var t;return null!=this.pinputX&&(this.inputIsActive?this.addPoint(this.activeSilkId,this.inputX,this.inputY,this.inputX-this.pinputX,this.inputY-this.pinputY):null!=(t=this.inputPreviewSilk)&&t.addPoint(this.inputX,this.inputY,this.inputX-this.pinputX,this.inputY-this.pinputY)),this.pinputX=this.inputX,this.pinputY=this.inputY},t.prototype.initInputEvents=function(){var e,i,n,r,o,s,a,l,u,h,c,t;return this.trackingInput=!0,this.inputX=this.inputY=null,this.pinputX=this.pinputY=null,this.inputIsActive=!1,this.nextInputPreviewSilk(),e=null,n=this,i=function(){var t;return n.inputIsActive||null!=(t=n.inputPreviewSilk)&&t.fadeIn(),clearTimeout(e),e=setTimeout(function(){var t;return null!=(t=n.inputPreviewSilk)?t.fadeOut():void 0},3e3)},$(this.sparksCanvas).mousedown((c=this,function(t){if(2!==t.button)return c.updateInputFromEvent(t),c.stopPreviewingInput(),c.inputStarted(),!1})).mousemove((h=this,function(t){return h.updateInputFromEvent(t),i()})).mouseup((u=this,function(t){return u.updateInputFromEvent(t),u.inputIsActive&&(u.nextInputPreviewSilk(),u.inputEnded()),i()})).mouseenter((l=this,function(t){return l.nextInputPreviewSilk()})).mouseleave((a=this,function(t){return a.stopPreviewingInput(),clearTimeout(e)})).bind("touchstart",(s=this,function(t){var e;return s.updateInputFromEvent(s.firstTouch(t)),e=[s.inputX,s.inputY],s.pinputX=e[0],s.pinputY=e[1],s.inputStarted(),!1})).bind("touchmove",(o=this,function(t){return o.updateInputFromEvent(o.firstTouch(t)),!1})).bind("touchend",(r=this,function(t){return r.updateInputFromEvent(r.firstTouch(t)),r.inputEnded(),!1})),$(window).mouseup((t=this,function(){return t.inputIsActive=!1}))},t.prototype.stopPreviewingInput=function(){var t;return null!=(t=this.inputPreviewSilk)&&t.completeAndFadeOut(),this.inputPreviewSilkId=null},t.prototype.inputStarted=function(){return this.inputIsActive=!0,this.complete(this.activeSilkId),this.activeSilkId=this.add()},t.prototype.inputEnded=function(){return this.complete(this.activeSilkId),this.inputIsActive=!1},t.prototype.firstTouch=function(t){return t.originalEvent.touches[0]||t.originalEvent.changedTouches[0]},t.prototype.updateInputFromEvent=function(t){return this.inputX=t.pageX-this.container.offsetLeft,this.inputY=t.pageY-this.container.offsetTop},t.prototype.getCenterCoordinates=function(){return[this.silkCanvas._util.halfWidthOnScreen,this.silkCanvas._util.halfHeightOnScreen]},t}(),s=function(){function t(t){this.canvas=t,this.ctx=t.getContext("2d"),this.ctx.globalCompositeOperation="lighter",this.points=[]}return t.prototype.frame=function(t){var e,i,n,r,o;for(this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),n=this.points,e=this.ctx;0<n.length&&n[0].age>=n[0].lifespan;)n.shift();for(r=0,o=n.length;r<o;r++)(i=n[r]).x+=i.vx*t,i.y+=i.vy*t,i.age++,i.age<i.lifespan&&(e.beginPath(),e.globalAlpha=i.a*(1-i.age/i.lifespan),i.invertA&&(e.globalAlpha=1-e.globalAlpha),e.fillStyle=i.color,e.arc(i.x,i.y,i.radius,0,2*Math.PI,!1),e.fill(),e.closePath())},t.prototype.add=function(t,e,i){var n;return(n=$.extend({x:t,y:e,a:1,age:0,lifespan:75,radius:.75,radiusScale:1,color:"#ffffff",vx:2*Math.random()-1,vy:Math.random()-1},i)).radius*=n.radiusScale,this.points.push(n),n},t}(),e=function(){function t(t,e){this.target=t,this.recordOnly=null!=e&&e,this.unserialize=l(this.unserialize,this),this.serialize=l(this.serialize,this),this.eject=l(this.eject,this),this.get=l(this.get,this),this.rewind=l(this.rewind,this),this.fastforward=l(this.fastforward,this),this.stop=l(this.stop,this),this.play=l(this.play,this),this.load=l(this.load,this),this.frame=l(this.frame,this),this.rec=l(this.rec,this),this.tape={},this.time=0,this.playing=!1}return t.prototype.rec=function(){var t,e,i;return t=1<=arguments.length?M.call(arguments,0):[],null==(e=this.tape)[i=this.time]&&(e[i]=[]),this.tape[this.time].push(t)},t.prototype.frame=function(){var t,e,i,n,r,o,s;if(this.playing){if(!this.recordOnly&&this.time in this.tape)for(n=0,r=(o=this.tape[this.time]).length;n<r;n++)i=(e=o[n])[0],t=2<=e.length?M.call(e,1):[],(s=this.target[i]).call.apply(s,[this.target].concat(M.call(t)));return this.time+=1}},t.prototype.load=function(t){return this.tape=t,this.rewind()},t.prototype.play=function(){return this.playing=!0},t.prototype.stop=function(){return this.playing=!1},t.prototype.fastforward=function(t){return this.time+=t},t.prototype.rewind=function(){return this.time=0},t.prototype.get=function(){return this.tape},t.prototype.eject=function(){var t;return t=this.tape,this.load({}),t},t.prototype.serialize=function(){return{time:this.time,playing:this.playing,tape:$.extend(!0,{},this.tape)}},t.prototype.unserialize=function(t){return this.tape=t.tape,this.time=t.time,this.playing=t.playing,t},t}(),o=function(){function t(t){this.target=t,this.recTape=new e(this.target,!0),this.playTape=new e(this.target),this.rec=this.recTape.rec,this.get=this.recTape.get}return t.prototype.frame=function(){return this.recTape.frame(),this.playTape.frame()},t.prototype.play=function(t){return null!=t&&(this.recTape.eject(),this.playTape.load(t)),this.playTape.play()},t.prototype.stopPlaying=function(){return this.playTape.stop()},t.prototype.startRecording=function(){return this.recTape.play()},t.prototype.stopRecording=function(){return this.recTape.stop()},t.prototype.ejectAll=function(){return this.playTape.eject(),this.recTape.eject()},t.prototype.serialize=function(){return{recTape:this.recTape.serialize(),playTape:this.playTape.serialize()}},t.prototype.unserialize=function(t){return this.recTape.unserialize(t.recTape),this.playTape.unserialize(t.playTape)},t}(),this.initSound=function(){var n,i,r,o,e,s,a,l,u,h,c,p,f,g,v,m,y,t,w,S,k,C,b,x,I,O;return this.audioContext=this.audioContext||this.webkitAudioContext,n=function(){function t(t,e){this.buffer=t,this.ctx=e,this.setLoop(!1),this.setVolume(1)}return t.prototype.setLoop=function(t){this.loop=t},t.prototype.setVolume=function(t){this.gain=t},t.prototype.createSource=function(){return this.source=this.ctx.createBufferSource(),this.source.buffer=this.buffer,this.source.loop=this.loop,this.source.gain.value=this.gain,this.source.connect(this.ctx.destination)},t.prototype.play=function(){var t;return null!=(t=this.source)?t.noteOn(0):void 0},t.prototype.fadeTo=function(t,e){var i;return this.gain=t,i=this.ctx.currentTime,this.source.gain.cancelScheduledValues(i),this.source.gain.setValueAtTime(this.source.gain.value,i),this.source.gain.linearRampToValueAtTime(this.gain,i+e)},t.prototype.trigger=function(t){var e,i;return null==t&&(t=1),e=this.triggerSource,this.triggerSource=this.triggerSourceBk,this.triggerSourceBk=e,null!=(i=this.triggerSource)&&i.noteOff(0),this.triggerSource=this.ctx.createBufferSource(),this.triggerSource.buffer=this.buffer,this.triggerSource.loop=this.loop,this.triggerSource.gain.value=this.gain*t,this.triggerSource.connect(this.ctx.destination),this.triggerSource.noteOn(0)},t}(),b=function(t){return"http://weavesilk.com.s3.amazonaws.com/sound/"+escape(t)},g=function(t,e,i,n){var r;return(r=new XMLHttpRequest).open("GET",t,!0),r.responseType="arraybuffer",r.onload=function(){return d("Loaded sound."),e.decodeAudioData(r.response,function(t){return d("Decoded"),"function"==typeof i?i(t):void 0},function(t){})},r.send()},null!=this.audioContext&&(a=new this.audioContext,f=function(t,i){var e;return e=b(t),g(e,a,function(t){var e;return e=new n(t,a),i(e)})},d("Thank the Lord, there is an audio context."),x=[],f("Clear 1 16-44.m4a",O=function(t){return d("onload",t),t.setVolume(.27),x.push(t),4===x.length}),I=1,w=function(){var t;if(0<x.length&&(d(x),t=_.random(x.length-1),x[t].trigger()),I<4)return f("Clear "+(I+1)+" 16-44.m4a",O),I+=1},u=null,f("Sparks 16-44 -looped.m4a",function(t){return(u=t).setVolume(0),u.setLoop(!0),u.createSource(),u.play()}),h=null,f("Draw B2 2048 loop.m4a",function(t){return d("woosh",t),(h=t).setVolume(0),h.setLoop(!0),h.createSource(),h.play()}),d("Attempting to load a whoosh"),c=!1,S=function(){return c=!0,null!=u&&u.fadeTo(.01,.5),null!=h?h.fadeTo(.15,.5):void 0},C=function(){return c=!1,null!=u&&u.fadeTo(0,1),null!=h?h.fadeTo(0,1):void 0},v=function(t){if(c)return t*=1/30,t=Math.log(Math.log(t+1)),t=_.constrain(t,.15,.6),null!=h?h.fadeTo(t,.2):void 0},e=null,f("Palette A5.m4a",function(t){return(e=t).setVolume(.4)}),s=null,f("Palette A4.m4a",function(t){return(s=t).setVolume(.3)})),y=ko.observable(!0),m=ko.observable(!0),t=ko.computed(function(){return y()&&m()}),k=!1,.5,.55,i=$("#bg-music")[0],r=$("#bg-music-intro")[0],o=!1,p=function(){return.5,15,.1,150,i.volume=0,i.play(),setTimeout(function(){var t;return t=setInterval(function(){if(i.volume+=.5/150,i.volume=Math.min(i.volume,.5)+.01,.5<=i.volume)return clearInterval(t)},100)},500)},l={muteMusic:y,muteSound:t,setMuteMusic:function(t){return y(t),t?_.save("muteMusic",!0):(_.save("muteMusic",!1),l.setMuteEffects(!1),l.start()),r.muted=t,i.muted=t},setMuteEffects:function(t){return m(t),t?_.save("muteEffects",!0):_.save("muteEffects")},start:function(){var e;if(!k&&!y())return k=!0,e=setInterval(function(){var t;if(t=0<i.buffered.length&&10<i.buffered.end(0),0<r.buffered.length&&2<r.buffered.end(0)&&!o&&(r.volume=.55,r.play(),o=!0),t)return clearInterval(e),p()},100)},playClearSound:function(){if(!m())return"function"==typeof w?w():void 0},playDrawSound:function(){try{if(!m())return"function"==typeof S?S():void 0}catch(t){return d("Error playing clear sound",t)}},stopDrawSound:function(){try{if(!m())return"function"==typeof C?C():void 0}catch(t){return d("Error stopping draw sound",t)}},modulateDrawSound:function(t){try{return"function"==typeof v?v(t):void 0}catch(t){return d("Error modulating draw sound",t)}},blip:function(t){try{if(!m())return null!=e?e.trigger(t):void 0}catch(t){return d("Error playing blip sound",t)}},bloop:function(t){try{if(!m())return null!=s?s.trigger(t):void 0}catch(t){return d("Error playing bloop sound",t)}}}},v=function(t){var e,i,n,r,o;return i=-1,o=function(){return $("#tips .tip")},n=function(){var t;if(!MobileDetect())return e(),t=o(),0<=i&&i<t.length?t.filter(":eq("+i+")").addClass("showing"):void 0},r=function(){if(!MobileDetect())return 2===++i&&(t.showColorPicker(!0),t.showSymmetryControls(!0),_.save("magicTipShown",!0)),n()},{hide:e=function(){return o().removeClass("showing")},show:n,showNext:r}},O=function(C){var t,e,h,i,n,I,r,s,a,o,l,u,c,p,f,g;return o=ko.observable(!1),l=ko.observable(!1),o.subscribe(function(t){return _.save("showColorPicker",t)}),l.subscribe(function(t){return _.save("showSymmetryControls",t)}),r=ko.observable(!1),I=ko.observable(!1),t=function(){var e,t,n,s,o,a,l,u;return a=l=e=o=s=null,t=function(t,e){var i;return(i={})[t]=e,n(i)},n=function(t,e){var i,n,r;if(null==t&&(t={}),null==e&&(e=null),h&&u())return(i=null!=s)?((r=s.serialize()).previewOpacity=s.previewOpacity,s.finish()):r={},n=$.extend(r,t,{previewRadius:5}),null!=e?n.previewEmphasis=e:null!=s&&(n.previewEmphasis=s.previewEmphasis),o=C.addPreviewSilk(n),s=C.getPreviewSilk(o),i||s.fadeInFromZero(),s.addPoint(a,l)},$(".control").mouseenter(function(){var o;return r(!0),d("enter",u()),o=0,e=setInterval(function(){var t,e,i,n,r;return t=(r=C.getCenterCoordinates())[0],e=r[1],i=10*Math.cos(.02*o),n=10*Math.sin(.02*o),a=t+i-100,l=e+n-100,null!=s&&s.addPoint(a,l),o++},1e3/30)}).mouseleave(function(){return r(!1),d("exit")}).mousemove(function(t){}),u=ko.computed(function(){var t;return(t=r()||I())||(null!=s&&s.completeAndFadeOut(),o=s=null,clearInterval(e)),t}),{newPreviewSilk:n,changeState:t,isActive:function(){return null!=o}}},a=function(e){var i;return C.silkSettingsState[e]=_.load(e,C.silkSettingsState[e]),i=ko.observable(C.silkSettingsState[e]),ko.computed({read:function(){return i()},write:function(t){return d("Saving",e,t),_.save(e,t),C.silkSettingsState[e]=t,i(t)}})},i=function(e,i,n){var r,o,t;return o=a(e),t=function(){var t;return t=r()?n:i,o(t),s.changeState(e,t)},[r=ko.computed(function(){return o()===i}),t]},h=!(e=function(t,o,s){var n,a,l,e,u,i,r,h,c,p,f,g,v,m,y,w,S,k,C,b,x;return r=(n=$(t))[0],(l=$(".handle",r))[0],(a=$(".ghost-handle",r))[0],e=n.find(".slider-bg"),u=n.find(".slider-bg-pc"),y=e.position(),S=y.top,w=y.left+parseInt(e.css("margin-left")),d("off",w),x=e.width(),v=e.height(),g=l.width(),f=g/2,C=null!=o.x,b=null!=o.y,i=function(t,e){var i,n,r;return null==e&&(e=!1),i={},C&&(n=t.x,i.x=n/x,a.css("left",n+w-f+"px"),e||(l.css("left",n+w-f+"px"),u.width(n+"px"),o.x=i.x)),b&&(r=t.y,i.y=r/v,a.css("top",r+S-f+"px"),e||(l.css("top",r+S-f+"px"),o.y=i.y)),s(i,e)},c=function(t){var e,i;return(i=t.pageX-n.offset().left-w)<0&&(i=0),x<i&&(i=x),e=x/6,Math.round(i/e)*e},p=function(t){var e;return(e=t.pageY-n.offset().top+S)<0&&(e=0),v<e&&(e=v),e},h=function(t){var e;return e={},C&&(e.x=c(t)),b&&(e.y=p(t)),e},k={},C&&(1<o.x&&(o.x=1),o.x<0&&(o.x=0),k.x=o.x*x),b&&(1<o.y&&(o.y=1),o.y<0&&(o.y=0),k.y=o.y*v),i(k),m=!1,n.on("mousedown",function(t){return I(m=!0),i(h(t))}).on("mousemove",function(t){if(I()===m)return i(h(t),!0)}).on("mouseup",function(t){return I(m=!1)}).mouseleave(function(t){if(!m)return s(o)}),$(window).on("mousemove",function(t){if(m)return i(h(t))}).on("mouseup",function(t){if(m)return I(m=!1)})}),function(){var b,x,t,e,i,n,r,o,I,s,a,u,l,h,O,c,P,p,A,d,f,g,T,v,m,y,w,S,k;for(T=2*Math.PI,p=Math.PI,g=2*Math.PI,a=3*Math.PI,x=function(t,e){return(e-t+a)%g-p},P=function(t){for(;T<t;)t-=T;for(;t<0;)t+=T;return t},I=function(t,e,i,n){return Math.sqrt(Math.pow(t-i,2)+Math.pow(e-n,2))},A=d3.select("#colorpicker"),b=$(A.node()),u=A.append("g"),O=d3.scale.linear().domain([0,90]).range([0,Math.PI/2]).clamp(!0),d=function(f,g,h,c,t,e){var p,d,i,o,n,v,m,y,w,s,S,r,k,a,C,l;return null==t&&(t=h),null==e&&(e=t),27,5,m=c,i=_.uniqueId(),d=A.append("defs").append("svg:clipPath").attr("id",i).append("path").attr("x",f).attr("y",g),n=_.uniqueId(),o=A.append("svg:defs").append("svg:linearGradient").attr("id",n).attr("x1","100%").attr("y1","0%").attr("x2","100%").attr("y2","100%").attr("spreadMethod","pad"),S=[o.append("svg:stop").attr("stop-opacity",1).attr("offset","0%"),o.append("svg:stop").attr("stop-opacity",1).attr("offset","25%"),o.append("svg:stop").attr("stop-opacity",1).attr("offset","50%"),o.append("svg:stop").attr("stop-opacity",1).attr("offset","75%"),o.append("svg:stop").attr("stop-opacity",1).attr("offset","100%")],w=new Array(40),p=function(t,e,i,n){var r,o,s,a,l,u,h,c,p,d;for(d=[],u=c=0,p=w.length;0<=p?c<p:p<c;u=0<=p?++c:--c)r=u/w.length*T,o=Math.cos(r),s=Math.sin(r),a=f+27*o,l=g+27*s,h=O(n),27<n&&Math.abs(x(r,i))<h&&n>I(a,l,t,e)?d.push(w[u]={x:t+5*o,y:e+5*s}):d.push(w[u]={x:a,y:l});return d},v=d3.svg.line().x(function(t){return t.x}).y(function(t){return t.y}).interpolate("linear-closed"),y=u.append("svg:path").style("fill","url(#"+n+")").attr("clip-path","url(#"+i+")"),k=function(t){return t.transition().ease("exp-out").duration(350)},s=function(t){var e,i;return e=50*(Math.cos(t)+1),i=50*(Math.sin(t)+1),o.attr({x1:e+"%",y1:i+"%",x2:100-e+"%",y2:100-i+"%"})},C=function(r,t){return t?k(o).duration(1e3).tween("gradient",function(){var t,e,i,n;return i=parseInt(o.attr("x1"))-50,n=parseInt(o.attr("y1"))-50,e=Math.atan2(n,i),t=x(P(e),P(r)),r=e+t,function(t){return s(t*r+(1-t)*e)}}):(o.transition(),s(r))},(a=function(t,e,i){var n,r,o,s,a,l,u,h;return null==i&&(i=!0),a=t-(u=b.offset()).left,l=e-u.top,t-f,e-g,o=0!==t&&0!==e?Math.atan2(l-g,a-f):0,(s=I(f,g,a,l))<22?(r=Math.PI/2,i&&(r=-r)):r=i?Math.PI+o:Math.PI/2,i?(n=!1,p(a,l,o,s)):(p(f,g,0,0),n=22<s),C(r,n),h=v(w),n?(k(y).attr("d",h),k(d).attr("d",h)):(y.attr("d",h),d.attr("d",h))})(f,g,!(l=function(){var t,e,i,n,r,o,s,a,l,u;for(t=d3.interpolateHcl(h,c),i=function(t){return 1/(1+Math.pow(Math.E,-(12*t-6)))},e=d3.scale.linear().domain([0,1]).range([0,.7]).clamp(!0),r=y.classed("selected"),u=[],a=0,l=S.length;a<l;a++)o=S[a],n=parseInt(o.attr("offset"))/100,s=r&&c!==m?i(e(n)):n,u.push(k(o).attr("stop-color",t(s)));return u})),l(),r={path:y,update:a,updateGradientAngle:C,trueColor:function(){return t},trueHighlightColor:function(){return e},color:function(){return h},highlightColor:function(t){return arguments.length?(c=null!=t?t:m,l(),r):c},select:function(){return y.classed("selected",!0),$("#selected-color-icon").css("color",m),r},deselect:function(){return y.classed("selected",!1),r}}},o=[["#3e95cc","#82cefc","#276f9b","#3dbbea"],["#53bf39","#65eb43","#53BD39"],["#e1d730","#fdf23f","#E3BF30"],["#ea5126","#fd722e","#EB5126"],["#db4775","#fd5e8f","#dd4876","#fe495e"],["#825ba1","#b585da"],["#555555","#717171"]],f=[],e=97.5,i=87.5,c=s=null,t=2*Math.PI/6,h=m=0,w=(k=o.slice(0,6)).length;m<w;h=++m)n=k[h],f.push(d.apply(null,[e+65*Math.cos(t*h),i+65*Math.sin(t*h)].concat(M.call(n))));for(f.push(d.apply(null,[e,i].concat(M.call(o[6])))),v=function(e){return $(e.path.node()).on("mouseover",function(){return null!=s&&s.highlightColor(e.highlightColor()),c=e}).on("mousemove",function(){}).on("mouseout",function(){return null!=s&&s.highlightColor(null),c=null}).on("mousedown",function(t){return 2!==t.button&&(this.parentNode.appendChild(this),e.path.style("pointer-events","none"),_.each(f,function(t){return t.highlightColor(null).deselect()}),e.select(),e.updateGradientAngle(-Math.PI/2),s=e)})},y=0,S=f.length;y<S;y++)v(f[y]);return r=f[0],l=f[1],r.highlightColor(l.highlightColor()).select(),C.silkSettingsState.color=r.trueColor(),C.silkSettingsState.highlightColor=l.trueColor(),$(window).on("mousemove",function(t){if(null!=s)return s.update(t.pageX,t.pageY)}).on("mouseup",function(t){var e,i;if(null!=s){for(s.update(t.pageX,t.pageY,!1),s.path.style("pointer-events",""),C.silkSettingsState.color=s.trueColor(),C.silkSettingsState.highlightColor=null!=c&&c!==s?c.trueColor():s.trueHighlightColor(),e=0,i=f.length;e<i;e++)f[e].deselect();s.select(),"undefined"!=typeof Hue&&null!==Hue&&Hue.setColor(C.silkSettingsState.color)}return c=s=null})}(),s=t(),n=(f=i("symMirror",!0,!1))[0],c=f[1],u=(g=i("spiralCopies",4,1))[0],p=g[1],$("#toggle-mirror").mouseenter(function(){return s.newPreviewSilk({},"mirror")}),$("#toggle-spiral").mouseenter(function(){return s.newPreviewSilk({},"spiral")}),e("#sym-num-rotations",{x:_.unlerp(1,6,_.load("symNumRotations",C.silkSettingsState.symNumRotations))},function(t,e){var i;return i={symNumRotations:Math.round(_.lerp(1,6,t.x))},_.save("symNumRotations",i.symNumRotations),1<i.symNumRotations?$("#sym-num-rotations-label").html(i.symNumRotations+"-fold rotational symmetry"):$("#sym-num-rotations-label").html("No rotational symmetry"),s.newPreviewSilk(i,"rotation"),e||C.extendSilkSettingsState(i),C.silkSettingsState}),h=!0,_.extend({tips:v({showColorPicker:o,showSymmetryControls:l}),mirror:n,toggleMirror:c,spiral:u,toggleSpiral:p,showColorPicker:o,showSymmetryControls:l,mouseOverPreviewableControls:r,mouseDownOnSlider:I})},$(function(){var o,t,e,i,n,r,s,a,l,u,h,c,p,f,g,v,m,y,w,S,k,C,b,x,I;return e=document.getElementById("canvii-container"),v=document.getElementById("silk-1"),t=document.getElementById("silk-2"),y=document.getElementById("sparks"),u=/(iPhone|iPod).*AppleWebKit/i.test(navigator.userAgent),h=ko.observable(0===window.orientation||180===window.orientation),k=function(){return h(0===window.orientation||180===window.orientation)},window.addEventListener("orientationchange",k,!1),a=function(){if(o.introSilkShowing())return m.clear(!1),o.introSilkShowing(!1)},$("#sparks").mousedown(a).on("touchstart",a),window._s=m=new Silks(e,v,t,y),m.initInputEvents(),S=O(m),w=+new Date,i=w+16,null!=(I=window.Hue)&&(I.setColor=function(t){var e,i,n,r;return t=d3.hsl(t),e=parseInt(t.h/360*65536),r=50<t.s?255:parseInt(255*t.s),i=parseInt(255*t.l),n=[1,2,3],"undefined"!=typeof Hue&&null!==Hue&&Hue.setBri(n,i),"undefined"!=typeof Hue&&null!==Hue?Hue.setHueSat(n,e,r):void 0}),r=0,s=$(window).height()/2,b=$(window).width()/2,f=function(t){return"http://r.weavesilk.com/?v=4&id="+t},x=!0,n=function(){if(r++,o.introSilkShowing()&&x)switch(!1){case 25!==r:l=m.add("intro",{symNumRotations:6,symMirror:!0,color:"#276f9b",highlightColor:"#825ba1",highlightMode:"time",timeColorScaleDomainHigh:500,symCenterX:b,symCenterY:s,startOpacity:.08,noiseOffset:1e4*Math.random(),drawsPerFrame:2});break;case!(25<=r&&r<137.5&&r%2==0):m.addPoint(l,b+5,s-5,0,0);break;case 137.5!==r:m.complete(l)}return w=+new Date,m.frame((w-i)/16),i=+new Date,setTimeout(n,16-(i-w))},l=null,(o={isIPhone:u,isRightSideUp:h,clipText:ko.observable("Copy link"),canUndo:m.snapshotState.canUndo,justCleared:m.snapshotState.justCleared,nextUndoIsRedo:m.nextUndoIsRedo,nextUndoIsNotRedo:ko.computed(function(){return!m.nextUndoIsRedo()}),introSilkShowing:ko.observable(!0),clear:function(){var t;return m.snapshotState.justCleared()||S.tips.showNext(),o.showingReplayThumbnail(!1),o.isReplay(!1),t=(t=window.location.href).substring(0,t.indexOf("?")),o.showIntro(!1),g(),m.clear()},undo:function(){return m.undo(),m.snapshotState.justCleared()?S.tips.show():S.tips.hide()},silkActive:ko.observable(!1),showAbout:ko.observable(!1),showDownload:ko.observable(!1),showIntro:ko.observable(!0),isFullscreen:ko.observable($.Fullscreen.isFullscreen()),toggleFullscreen:function(){return $.Fullscreen.isFullscreen()?($.Fullscreen.cancelFullscreen(),o.isFullscreen(!1)):($("html").requestFullscreen(),o.isFullscreen(!0))},showColorPicker:S.showColorPicker,showSymmetryControls:S.showSymmetryControls,mouseOverControls:S.mouseOverControls,mouseDownOnSlider:S.mouseDownOnSlider,mirror:S.mirror,toggleMirror:S.toggleMirror,spiral:S.spiral,toggleSpiral:S.toggleSpiral,shareLoading:ko.observable(!1),showShareOptions:ko.observable(!1),shareUrlDirect:ko.observable(""),shareUrlThumbnail:ko.observable(""),toggleSound:function(){},toggleAbout:function(){return o.showAbout(!o.showAbout())},toggleAllControls:function(){return o.showDownload(!1),o.showColorPicker(!o.showColorPicker()),o.showSymmetryControls(!o.showSymmetryControls())},download:function(){return o.showDownload()?o.showDownload(!1):(o.showDownload(!0),o.showColorPicker(!1),o.showSymmetryControls(!1),$("#download-image").attr("src",m.getImageUrl()))},shareButtonClick:function(){if(!o.shareDisabled())return o.hideReplayThumbnail(),o.shareUrlDirect()?o.showShareOptions(!0):(o.shareLoading(!0),o.showShareOptions(!1),$.ajax({url:"http://weavesilk-replays.herokuapp.com/v4/save_replay",type:"POST",dataType:"json",data:{json:JSON.stringify(m.getReplay()),thumb:m.makeThumb()},success:function(t){var e,i,n,r;return d("Got",_typeof(t),"data:",t),e=(r=t.result).id,i=r.thumbUrl,n=f(e),o.shareUrlDirect(n),o.shareUrlThumbnail(i),o.showShareOptions(!0)},error:function(t){return alert("There was an error uploading your picture. Maybe try again?"),o.showShareOptions(!1)},complete:function(){return o.shareLoading(!1)}}))},toggleControls:function(){return o.controlsVisible(!o.controlsVisible())}}).showingReplayThumbnail=ko.observable(!1),o.hideReplayThumbnail=function(){return o.showingReplayThumbnail(!1)},o.isReplay=ko.observable(!1),o.isOnMobile=ko.observable(MobileDetect()),o.shareUrlEmail=ko.computed(function(){var t;return t=o.shareUrlDirect(),"mailto:?subject="+escape("Silk -- Interactive generative art")+"&body="+escape("I just drew this on weavesilk.com: "+t)}),o.pristine=ko.observable(!o.showColorPicker()),o.muted=ko.observable(!0),o.notMuted=ko.computed(function(){return!o.muted()}),o.toggleMute=function(){d},g=function(){return o.showShareOptions(!1),o.shareUrlDirect("")},o.notPristine=ko.computed(function(){return!o.pristine()}),o.announcementClosePressed=ko.observable(!1),o.closeAnnouncement=function(){return o.announcementClosePressed(!0),_.save("announcementClosePressed",!0)},o.hideAllAds=ko.observable(!1),o.showAnyAnnouncement=ko.computed(function(){return o.notPristine()&&!o.hideAllAds()}),$("#about-button").dblclick(function(){return o.hideAllAds(!o.hideAllAds())}),o.numClears=ko.observable(0),o.justCleared.subscribe(function(t){if(t)return o.numClears(1+o.numClears())}),o.showBigAnnouncementDefault=ko.computed(function(){return o.showAnyAnnouncement()&&(o.introSilkShowing()||o.justCleared()&&o.notPristine()||o.isReplay()||o.isOnMobile())}),o.notShowBigAnnouncementDefault=ko.computed(function(){return!o.showBigAnnouncementDefault()}),o.showBigAnnouncement=ko.computed(function(){var t;return t=navigator.userAgent.match(/Android/i),o.numClears()<5?o.showAnyAnnouncement()&&!t:o.showBigAnnouncementDefault()&&!t}),o.notPristineAndJustCleared=ko.computed(function(){return!o.pristine()&&o.justCleared()}),o.shareDisabled=ko.computed(function(){return o.justCleared()||o.shareLoading()}),o.notShareDisabled=ko.computed(function(){return!o.shareDisabled()}),o.showShareButton=ko.computed(function(){return o.notPristine()&&!o.showShareOptions()}),o.isNotFullscreen=ko.computed(function(){return!o.isFullscreen()}),o.shareUrlFacebook=ko.computed(function(){var t;return t=encodeURI(o.shareUrlDirect()),"https://www.facebook.com/dialog/feed?app_id=408271179236250&link="+escape(t)+"&picture="+encodeURI(o.shareUrlThumbnail())+"&name=Silk – Interactive Generative Art&caption="+escape("weavesilk.com")+"&description="+encodeURI("Create beautiful flowing art with Silk.")+"&redirect_uri="+encodeURI(t)}),o.shareUrlTwitter=ko.computed(function(){var t;return t=encodeURI(o.shareUrlDirect()),"https://twitter.com/share?url="+escape(t)+"&text="+escape("Look what I drew with #weavesilk!")}),o.shareUrlPinterest=ko.computed(function(){return"http://pinterest.com/pin/create/button/?url="+encodeURI(o.shareUrlDirect())+"&media="+encodeURI(o.shareUrlThumbnail())}),m.drawInputPreview=!1,c=p=0,$("#sparks").mousedown(function(t){return c=t.pageX,p=t.pageY,o.silkActive(!0),g(),S.tips.hide(),o.showDownload(!1),o.showAbout(!1),o.showIntro(!1),o.hideReplayThumbnail()}).mousemove(function(t){return c-t.pageX,p-t.pageY,c=t.pageX,p=t.pageY}).mouseup(function(t){o.pristine(!1),o.silkActive(!1),m.drawInputPreview=!0}).on("touchstart",function(t){return c=t.pageX,p=t.pageY,o.silkActive(!0),g(),S.tips.hide(),o.showDownload(!1),o.showAbout(!1),o.showIntro(!1)}).on("touchend",function(t){return o.pristine(!1),o.silkActive(!1)}),ko.applyBindings(o),MobileDetect()&&$("#main-controls .silk-icon").css("display","none"),key("n, x, space",_.throttle(function(){return o.clear(),o.showDownload(!1)},150)),key("z, u",_.throttle(o.undo,150)),key("r",m.replayReplay),key("c",o.toggleAllControls),C={},function(){var t,e,i,n,r,o;for(i=/\+/g,r=/([^&=]+)=?([^&]*)/g,t=function(t){return decodeURIComponent(t.replace(i," "))},n=window.location.search.substring(1),o=[];e=r.exec(n);)o.push(C[t(e[1])]=t(e[2]))}(),$(".direct-link").focus(function(){return $(this).select()}),o.showShareOptions.subscribe(function(t){if(!t)return $(".direct-link").blur()}),null!=C.id&&null!=C.v&&(o.pristine(!1),o.showIntro(!1),x=!1,o.showingReplayThumbnail(!0),o.isReplay(!0),$.ajax({url:"http://weavesilk.s3.amazonaws.com/v"+C.v+"/uploads/replay/"+C.id+".json",type:"GET",dataType:"json",success:function(t){var e;return d("Got data:",t),m.playReplay(t),e=f(C.id),o.introSilkShowing(!1),o.showShareOptions(!1),o.shareUrlDirect(e),o.shareUrlThumbnail("http://weavesilk.s3.amazonaws.com/v4/uploads/thumb/"+C.id+".png")}})),n()})}).call(void 0);