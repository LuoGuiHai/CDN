"use strict";function loadStarData(e,t){var i=new XMLHttpRequest;setLoadMessage("Fetching stellar data"),i.addEventListener("load",function(e){var a=JSON.parse(i.responseText);t&&(setLoadMessage("Parsing stellar data"),t(a))},!1),i.open("GET",e,!0),i.send(null)}var datastarTexture0=THREE.ImageUtils.loadTexture("https://cdn.jsdelivr.net/gh/LuoGuiHai/CDN/test/starmap/images/p_0.png"),datastarTexture1=THREE.ImageUtils.loadTexture("https://cdn.jsdelivr.net/gh/LuoGuiHai/CDN/test/starmap/images/p_2.png"),datastarHeatVisionTexture=THREE.ImageUtils.loadTexture("https://cdn.jsdelivr.net/gh/LuoGuiHai/CDN/test/starmap/images/sharppoint.png"),starPreviewTexture=THREE.ImageUtils.loadTexture("https://cdn.jsdelivr.net/gh/LuoGuiHai/CDN/test/starmap/images/star_preview.png",void 0,setLoadMessage("Focusing optics")),starColorGraph=THREE.ImageUtils.loadTexture("https://cdn.jsdelivr.net/gh/LuoGuiHai/CDN/test/starmap/images/star_color_modified.png"),datastarUniforms={color:{type:"c",value:new THREE.Color(16777215)},texture0:{type:"t",value:datastarTexture0},texture1:{type:"t",value:datastarTexture1},heatVisionTexture:{type:"t",value:datastarHeatVisionTexture},spectralLookup:{type:"t",value:starColorGraph},idealDepth:{type:"f",value:1},blurPower:{type:"f",value:1},blurDivisor:{type:"f",value:2},sceneSize:{type:"f",value:120},cameraDistance:{type:"f",value:800},zoomSize:{type:"f",value:1},scale:{type:"f",value:1},brightnessScale:{type:"f",value:1},heatVision:{type:"f",value:0}},datastarAttributes={size:{type:"f",value:[]},customColor:{type:"c",value:[]},colorIndex:{type:"f",value:[]}};function generateHipparcosStars(){var i=new THREE.Object3D,e=new THREE.Geometry,a=starData.length,t=new THREE.Object3D;i.add(t);for(var s=new THREE.MeshBasicMaterial({map:starPreviewTexture,blending:THREE.AdditiveBlending,transparent:!0,depthTest:!1,depthWrite:!1}),r=new THREE.Mesh(new THREE.PlaneGeometry(40,40),s),n=new THREE.Geometry,o=0;o<a;o++){var l=starData[o],d=3.26156*l.d;if(1e7<=d)l.position=new THREE.Vector3;else{0==o&&(lat=0,d=lon=0);var p=new THREE.Vector3(0,0,0),c=l.ra,h=l.dec,u=15*(c+90)*Math.PI/180,v=h*Math.PI/180,E=d,m=E*Math.cos(v),T=m*Math.cos(u),g=m*Math.sin(u),H=E*Math.sin(v);p.set(T,g,H),p.size=20,p.name=l.name,p.spectralIndex=l.c,l.c<=-1&&(l.c=0),p.spectralLookup=map(l.c,-.3,1.52,0,1),0==o&&(p.size=0),e.vertices.push(p);var f=1,R=new THREE.Color;R.r=1,R.g=f,R.b=1,e.colors.push(R)}}var M=new THREE.Matrix4,w=new THREE.Euler(Math.PI/2,Math.PI,-Math.PI/2),y=new THREE.Quaternion;for(var o in y.setFromEuler(w),M.makeRotationFromQuaternion(y),e.applyMatrix(M),e.vertices){if(void 0!==(p=e.vertices[o]).name&&0<p.name.length){n.vertices.push(p.clone());var x=p.clone();x.y=0,n.vertices.push(x);var b=r.clone(),z=new THREE.Gyroscope;z.position.copy(p),z.add(b),b.update=function(){this.material.opacity=constrain(Math.pow(.002*camera.position.z,2),0,1),this.material.opacity<.1&&(this.material.opacity=0),this.material<=0?this.visibile=!1:this.visible=!0,this.scale.setLength(constrain(Math.pow(.001*camera.position.z,2),0,1))};f=new THREE.Gyroscope;i.add(f),f.name=p.name,f.spectralIndex=p.spectralIndex,f.position.copy(p),f.scale.setLength(.2),attachMarker(f),t.add(z)}}var L=new THREE.ShaderMaterial({uniforms:datastarUniforms,attributes:datastarAttributes,vertexShader:shaderList.datastars.vertex,fragmentShader:shaderList.datastars.fragment,blending:THREE.AdditiveBlending,depthTest:!1,depthWrite:!1,transparent:!0});i.heatVision=!1,i.shaderMaterial=L,i.toggleHeatVision=function(e){void 0!==e&&(i.heatVision=!e),0==i.heatVision?(i.shaderMaterial.blending=THREE.NormalBlending,i.shaderMaterial.depthTest=!0,i.shaderMaterial.depthWrite=!0,i.shaderMaterial.transparent=!1):(i.shaderMaterial.blending=THREE.AdditiveBlending,i.shaderMaterial.depthTest=!1,i.shaderMaterial.depthWrite=!1,i.shaderMaterial.transparent=!0),i.heatVision=!i.heatVision,i.heatVision?($spectralGraph.addClass("heatvision").fadeIn(),$iconNav.addClass("heatvision")):($spectralGraph.removeClass("heatvision").fadeOut(),$iconNav.removeClass("heatvision"))},window.toggleHeatVision=i.toggleHeatVision;var U=new THREE.ParticleSystem(e,L);U.dynamic=!1;for(var V=datastarAttributes.size.value,G=datastarAttributes.customColor.value,I=datastarAttributes.colorIndex.value,D=0;D<e.vertices.length;D++)V[D]=e.vertices[D].size,G[D]=e.colors[D],I[D]=e.vertices[D].spectralLookup;var C=new THREE.Line(n,new THREE.LineBasicMaterial({color:3355443,blending:THREE.AdditiveBlending,depthTest:!1,depthWrite:!1,transparent:!0}),THREE.LinePieces);U.add(C);for(o=0;o<12;o++){var P=o/12*360,S=new THREE.Gyroscope;S.scale.setLength(.8);w=o/12*Math.TWO_PI,T=600*Math.cos(w),g=600*Math.sin(w);S.position.x=T,S.position.z=-g,S.name=P+"Â°",attachMarker(S,1),i.add(S)}var A=THREE.ImageUtils.loadTexture("https://cdn.jsdelivr.net/gh/LuoGuiHai/CDN/test/starmap/images/starbase.png"),N=new THREE.MeshBasicMaterial({map:A,blending:THREE.AdditiveBlending,transparent:!0,depthTest:!1,depthWrite:!1,side:THREE.DoubleSide}),j=new THREE.PlaneGeometry(10,10),B=(M=new THREE.Matrix4,new THREE.Euler(Math.PI/2,0,0));(y=new THREE.Quaternion).setFromEuler(B),M.makeRotationFromQuaternion(y),j.applyMatrix(M);var W=new THREE.Geometry;new THREE.Object3D;for(var o in e.vertices){if(void 0!==(p=e.vertices[o]).name&&0<p.name.length){var k=j.clone(),F=new THREE.Matrix4;F.setPosition(p.x,0,p.z),k.applyMatrix(F),THREE.GeometryUtils.merge(W,k)}}var O=new THREE.Mesh(W,N);return O.update=function(){this.material.opacity=constrain(.002*(camera.position.z-400),0,1),this.material.opacity<=0?this.visible=!1:this.visible=!0},U.add(O),i.add(U),i.update=function(){var e=(camera.position.z+5e3)/6e4;e=constrain(e,0,.2);var a=constrain(10/Math.sqrt(camera.position.z),0,1);i.heatVision?(datastarUniforms.cameraDistance.value=0,datastarUniforms.brightnessScale.value=1,datastarUniforms.heatVision.value+=.2*(1-datastarUniforms.heatVision.value)):(datastarUniforms.brightnessScale.value=a,datastarUniforms.heatVision.value+=.2*(0-datastarUniforms.heatVision.value)),datastarUniforms.heatVision.value<.01&&(datastarUniforms.heatVision.value=0),datastarUniforms.cameraDistance.value=e,datastarUniforms.zoomSize.value=constrain(camera.position.z/4e3,0,1);var t=window.innerWidth*window.innerHeight;datastarUniforms.scale.value=1.5*Math.sqrt(t),camera.position.z,datastarUniforms.sceneSize.value=1e4},C.update=function(){camera.position.z<1500?this.material.opacity=constrain(.002*(camera.position.z-400),0,1):this.material.opacity+=.1*(0-this.material.opacity),camera.position.z<250?this.visible=!1:this.visible=!0},i}