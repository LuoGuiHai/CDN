"use strict";var sunTexture,sunColorLookupTexture,solarflareTexture,sunHaloTexture,sunHaloColorTexture,sunCoronaTexture;function loadStarSurfaceTextures(){void 0===sunTexture&&((sunTexture=THREE.ImageUtils.loadTexture("https://cdn.jsdelivr.net/gh/LuoGuiHai/CDN/test/starmap/images/sun_surface.png",void 0,setLoadMessage("Igniting solar plasma"))).anisotropy=maxAniso,sunTexture.wrapS=sunTexture.wrapT=THREE.RepeatWrapping),void 0===sunColorLookupTexture&&(sunColorLookupTexture=THREE.ImageUtils.loadTexture("https://cdn.jsdelivr.net/gh/LuoGuiHai/CDN/test/starmap/images/star_colorshift.png")),void 0===solarflareTexture&&(solarflareTexture=THREE.ImageUtils.loadTexture("https://cdn.jsdelivr.net/gh/LuoGuiHai/CDN/test/starmap/images/solarflare.png",void 0,setLoadMessage("Distributing solar flares"))),void 0===sunHaloTexture&&(sunHaloTexture=THREE.ImageUtils.loadTexture("https://cdn.jsdelivr.net/gh/LuoGuiHai/CDN/test/starmap/images/sun_halo.png",void 0,setLoadMessage("Calculating coronal mass"))),void 0===sunHaloColorTexture&&(sunHaloColorTexture=THREE.ImageUtils.loadTexture("https://cdn.jsdelivr.net/gh/LuoGuiHai/CDN/test/starmap/images/halo_colorshift.png")),void 0===sunCoronaTexture&&(sunCoronaTexture=THREE.ImageUtils.loadTexture("https://cdn.jsdelivr.net/gh/LuoGuiHai/CDN/test/starmap/images/corona.png",void 0,setLoadMessage("Projecting coronal ejecta")))}var surfaceGeo=new THREE.SphereGeometry(7.35144e-8,60,30);function makeStarSurface(e,t){var a=new THREE.ShaderMaterial({uniforms:t,vertexShader:shaderList.starsurface.vertex,fragmentShader:shaderList.starsurface.fragment});return new THREE.Mesh(surfaceGeo,a)}var haloGeo=new THREE.PlaneGeometry(22e-8,22e-8);function makeStarHalo(e){var t=new THREE.ShaderMaterial({uniforms:e,vertexShader:shaderList.starhalo.vertex,fragmentShader:shaderList.starhalo.fragment,blending:THREE.AdditiveBlending,depthTest:!1,depthWrite:!1,color:16777215,transparent:!0,polygonOffset:!0,polygonOffsetFactor:1,polygonOffsetUnits:100}),a=new THREE.Mesh(haloGeo,t);return a.position.set(0,0,0),a}var glowGeo=new THREE.PlaneGeometry(12e-7,12e-7);function makeStarGlow(e){var t=new THREE.ShaderMaterial({uniforms:e,blending:THREE.AdditiveBlending,fragmentShader:shaderList.corona.fragment,vertexShader:shaderList.corona.vertex,color:16777215,transparent:!0,polygonOffset:!0,polygonOffsetFactor:-1,polygonOffsetUnits:100,depthTest:!0,depthWrite:!0}),a=new THREE.Mesh(glowGeo,t);return a.position.set(0,0,0),a}function makeStarLensflare(e,t,a){var r=addStarLensFlare(0,0,t,e,void 0,a);return r.customUpdateCallback=function(e){if(0!=e.visible){var t,a,r=this.lensFlares.length,o=2*-this.positionScreen.x,s=2*-this.positionScreen.y,n=e.size?e.size:16e3,i=camera.position.length();for(t=0;t<r;t++)(a=this.lensFlares[t]).x=this.positionScreen.x+o*a.distance,a.y=this.positionScreen.y+s*a.distance,a.scale=n/Math.pow(i,2)*2,a.opacity=i<10?Math.pow(2*i,2):1,a.rotation=0;for(t=2;t<r;t++){a=this.lensFlares[t];var l=Math.sqrt(Math.pow(a.x,2)+Math.pow(a.y,2));a.opacity=constrain(l,0,1),a.wantedRotation=a.x*Math.PI*.25,a.rotation+=.25*(a.wantedRotation-a.rotation)}}},r}var solarflareGeometry=new THREE.TorusGeometry(3e-8,1e-9+2e-9,60,90,.15+Math.PI);function makeSolarflare(e){for(var t=new THREE.ShaderMaterial({uniforms:e,vertexShader:shaderList.starflare.vertex,fragmentShader:shaderList.starflare.fragment,blending:THREE.AdditiveBlending,color:16777215,transparent:!0,depthTest:!0,depthWrite:!1,polygonOffset:!0,polygonOffsetFactor:-100,polygonOffsetUnits:1e3}),a=new THREE.Object3D,r=0;r<6;r++){var o=new THREE.Mesh(solarflareGeometry,t);o.rotation.y=Math.PI/2,o.speed=.01*Math.random()+.005,o.rotation.z=Math.PI*Math.random()*2,o.rotation.x=-Math.PI+2*Math.PI,o.update=function(){this.rotation.z+=this.speed};var s=new THREE.Object3D;s.position.x=2*Math.random()-1,s.position.y=2*Math.random()-1,s.position.z=2*Math.random()-1,s.position.multiplyScalar(5.881152e-8),s.lookAt(new THREE.Vector3(0,0,0)),s.add(o),a.add(s)}return a}function makeSun(e){var t=e.radius,a=e.spectral;loadStarSurfaceTextures();var r={texturePrimary:{type:"t",value:sunTexture},textureColor:{type:"t",value:sunColorLookupTexture},textureSpectral:{type:"t",value:starColorGraph},time:{type:"f",value:0},spectralLookup:{type:"f",value:0}},o={texturePrimary:{type:"t",value:solarflareTexture},time:{type:"f",value:0},textureSpectral:{type:"t",value:starColorGraph},spectralLookup:{type:"f",value:0}},s={texturePrimary:{type:"t",value:sunHaloTexture},textureColor:{type:"t",value:sunHaloColorTexture},time:{type:"f",value:0},textureSpectral:{type:"t",value:starColorGraph},spectralLookup:{type:"f",value:0}},n={texturePrimary:{type:"t",value:sunCoronaTexture},textureSpectral:{type:"t",value:starColorGraph},spectralLookup:{type:"f",value:0}},i=new THREE.Object3D,l=makeStarSurface(t,r);i.add(l);var u=makeSolarflare(o);i.solarflare=u,i.add(u);var p=new THREE.Gyroscope;i.add(p),i.gyro=p;var d=makeStarLensflare(1.5,1e-4,a);i.lensflare=d,i.lensflare.name,p.add(d);var h=makeStarHalo(s);p.add(h);var f=makeStarGlow(n);p.add(f);var m=new THREE.MeshBasicMaterial({map:glowSpanTexture,blending:THREE.AdditiveBlending,transparent:!0,depthTest:!0,depthWrite:!0,wireframe:!0,opacity:.8}),c=new THREE.Mesh(new THREE.IcosahedronGeometry(1.25*t,2),m);return c.update=function(){this.rotation.y+=.001,this.rotation.z-=9e-4,this.rotation.x-=4e-4},c.material.map.wrapS=THREE.RepeatWrapping,c.material.map.wrapT=THREE.RepeatWrapping,c.material.map.needsUpdate=!0,c.material.map.onUpdate=function(){this.offset.y-=.01,this.needsUpdate=!0},i.add(c),i.sunUniforms=r,i.solarflareUniforms=o,i.haloUniforms=s,i.coronaUniforms=n,i.setSpectralIndex=function(e){var t=map(e,-.3,1.52,0,1);t=constrain(t,0,1),this.starColor=t,this.sunUniforms.spectralLookup.value=t,this.solarflareUniforms.spectralLookup.value=t,this.haloUniforms.spectralLookup.value=t,this.coronaUniforms.spectralLookup.value=t},i.setScale=function(e){this.scale.setLength(e),this.gyro.remove(this.lensflare);var t=4+.5*e+.1*Math.pow(e,2);t<1.5&&(t=1.5),this.lensflare=makeStarLensflare(t,2e-4*e,this.starColor),this.lensflare.name="lensflare",this.gyro.add(this.lensflare)},i.randomizeSolarFlare=function(){this.solarflare.rotation.x=Math.random()*Math.PI*2,this.solarflare.rotation.y=Math.random()*Math.PI*2},i.setSpectralIndex(a),i.update=function(){if(this.sunUniforms.time.value=shaderTiming,this.haloUniforms.time.value=shaderTiming+rotateYAccumulate,this.solarflareUniforms.time.value=shaderTiming,400<camera.position.z){var e=this.gyro.getObjectByName("lensflare");void 0!==e&&this.gyro.remove(e)}else void 0===this.gyro.getObjectByName("lensflare")&&this.gyro.add(this.lensflare)},gui.add(r.spectralLookup,"value",-.25,1.5).onChange(function(e){i.setSpectralIndex(e)}),i}