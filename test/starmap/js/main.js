"use strict";var masterContainer=document.getElementById("visualization");THREE.ImageUtils.crossOrigin=null;var rotating,translating,starData,pSystem,pGalacticSystem,pDustSystem,earth,spacePlane,screenWhalf,screenHhalf,divCSSWorld,divCSSCamera,fovValue,screenWidth,screenHeight,gradientImage,gradientCanvas,rt,maxAniso=1,enableDataStar=!0,enableSkybox=!0,enableGalaxy=!0,enableDust=!1,enableSolarSystem=!0,enableSpacePlane=!0,enableStarModel=!0,enableTour=!0,enableDirector=!0,firstTime=!localStorage||null==localStorage.getItem("first"),tour=new Tour(GALAXY_TOUR),initialAutoRotate=!0,startTime=Date.now(),clock=new THREE.Clock,shaderTiming=0,$starName=$("#star-name"),$iconNav=$("#icon-nav"),$detailContainer=$("#detailContainer"),$cssContainer=$("#css-container"),$spectralGraph=$("#spectral-graph"),lastRotateY=0,rotateYAccumulate=0,rtparam={minFilter:THREE.LinearFilter,magFilter:THREE.LinearFilter,format:THREE.RGBFormat,stencilBufer:!1},antialias=1==gup("antialias");function start(e){if(!Detector.webgl)return Detector.Chrome?void Detector.addGetWebGLMessage(['Your graphics card does not support WebGL. Please try again on a different Windows, Mac, or Linux computer using <a href="http://www.google.com/chrome/" style="color:#ffffff; text-decoration:underline; text-transform:capitalize">Google Chrome</a><br>','or another <a href="http://www.khronos.org/webgl/wiki_1_15/index.php/Getting_a_WebGL_Implementation" style="color:#ffffff; text-decoration:underline; text-transform:none"> WebGL-Compatible browser</a>. You can watch a video preview of the experiment below:','<p><iframe style="margin-top:4em;" id="trailer" width=800 height=600 src="http://www.youtube.com/embed/TU6RAjABX40" frameborder="0" allowfullscreen></iframe></p>'].join("\n")):void Detector.addGetWebGLMessage();(gradientImage=document.createElement("img")).onload=postStarGradientLoaded,gradientImage.src="https://cdn.jsdelivr.net/gh/LuoGuiHai/CDN/test/starmap/images/star_color_modified.png"}var gui,postStarGradientLoaded=function(){(gradientCanvas=document.createElement("canvas")).width=gradientImage.width,gradientCanvas.height=gradientImage.height,gradientCanvas.getContext("2d").drawImage(gradientImage,0,0,gradientImage.width,gradientImage.height),gradientCanvas.getColor=function(e){return this.getContext("2d").getImageData(0,e*gradientImage.height,1,1).data},loadShaders(shaderList,function(e){shaderList=e,postShadersLoaded()})},postShadersLoaded=function(){enableDataStar?loadStarData("https://cdn.jsdelivr.net/gh/LuoGuiHai/CDN/test/starmap/data/stars_all.json",function(e){starData=e.stars,initScene(),animate()}):(initScene(),animate())},controllers={viewSize:.6,datastarSize:1,sceneSize:1e3,sol:function(){camera.position.z=1.1},solarsystem:function(){camera.position.z=18},hipparcos:function(){camera.position.z=1840},milkyway:function(){camera.position.z=4e4}};function buildGUI(){(gui=new dat.GUI).domElement.style.display="none",c=gui.add(controllers,"viewSize",.01,4),c.onChange(function(e){camera.scale.z=e}),c=gui.add(controllers,"datastarSize",.01,10),c=gui.add(controllers,"sceneSize",1,5e4),c=gui.add(controllers,"sol"),c=gui.add(controllers,"solarsystem"),c=gui.add(controllers,"hipparcos"),c=gui.add(controllers,"milkyway"),initializeMinimap()}function initScene(){scene=new THREE.Scene,scene.add(new THREE.AmbientLight(5263440)),rotating=new THREE.Object3D,galacticCentering=new THREE.Object3D,translating=new THREE.Object3D,galacticCentering.add(translating),rotating.add(galacticCentering),scene.add(rotating),translating.targetPosition=new THREE.Vector3,translating.update=function(){this.easePanning||(this.position.lerp(this.targetPosition,.1),this.position.distanceTo(this.targetPosition)<.01&&this.position.copy(this.targetPosition))},screenWidth=window.innerWidth,screenHeight=window.innerHeight,screenWhalf=window.innerWidth/2,screenHhalf=window.innerHeight/2,renderer=new THREE.WebGLRenderer({antialias:antialias});renderer.setSize(1*screenWidth,1*screenHeight),renderer.domElement.style.width=screenWidth+"px",renderer.domElement.style.height=screenHeight+"px",renderer.autoClear=!1,renderer.sortObjects=!1,renderer.generateMipmaps=!1,maxAniso=renderer.getMaxAnisotropy(),document.getElementById("glContainer").appendChild(renderer.domElement),window.addEventListener("mousemove",onDocumentMouseMove,!0),masterContainer.addEventListener("windowResize",onDocumentResize,!0),masterContainer.addEventListener("mousedown",onDocumentMouseDown,!0),window.addEventListener("mouseup",onDocumentMouseUp,!1),masterContainer.addEventListener("click",onClick,!0),masterContainer.addEventListener("mousewheel",onMouseWheel,!1),masterContainer.addEventListener("keydown",onKeyDown,!1),masterContainer.addEventListener("touchstart",touchStart,!1),window.addEventListener("touchend",touchEnd,!1),window.addEventListener("touchmove",touchMove,!1),camera=new THREE.PerspectiveCamera(30,window.innerWidth/window.innerHeight,.5,1e7),camera.position.z=2e3,camera.rotation.vx=0,camera.rotation.vy=0,camera.position.target={x:0,z:2e3,pz:2e3},enableSkybox&&setupSkyboxScene(),camera.update=function(){this.__tour||this.easeZooming||(camera.position.z+=.125*(camera.position.target.z-camera.position.z))},camera.position.y=0,camera.scale.z=.83,scene.add(camera);THREEx.WindowResize(renderer,camera);enableSkybox&&THREEx.WindowResize(renderer,cameraCube),rotateY=Math.PI/2,rotateX=.05*Math.PI,buildGUI(),sceneSetup(),initCSS3D();var t=$("#ex-out").click(function(e){e.preventDefault(),$detailContainer.fadeOut(),$("#css-container").css("display","block"),$detailContainer.hasClass("about")&&$detailContainer.removeClass("about")}),a=$("#zoom-back").click(function(e){e.preventDefault(),t.click(),zoomOut(750)});$.get("https://cdn.jsdelivr.net/gh/LuoGuiHai/CDN/test/starmap/images/icons/zoom-out.svg",function(e){$(e).find("svg").addClass("icon").appendTo(a)}),setTimeout(function(){var e="scale(1.0)";$("#layout").css({webkitTransform:e,mozTransform:e,msTransform:e,oTransform:e,transform:e}),$("#loader").fadeOut(250),$iconNav.fadeIn(),$iconNav.isReady=!0,firstTime?(displayIntroMessage(),localStorage&&localStorage.setItem("first",0)):_.delay(function(){$iconNav.find("#tour-button").trigger("mouseover")},500),0<markers.length&&markers[0].select()},500),document.getElementById("bgmusicA").addEventListener("ended",function(){this.currentTime=0,this.pause();setTimeout(function(){document.getElementById("bgmusicB").play()},15e3)},!1),document.getElementById("bgmusicB").addEventListener("ended",function(){this.currentTime=0,this.pause();setTimeout(function(){document.getElementById("bgmusicA").play()},15e3)},!1),document.getElementById("bgmusicA").play(),localStorage&&0==localStorage.getItem("sound")&&muteSound()}function sceneSetup(){if(enableStarModel&&(starModel=makeStarModels(),starModel.setSpectralIndex(.9),starModel.setScale(1),translating.add(starModel)),enableDataStar&&(pSystem=generateHipparcosStars(),translating.add(pSystem)),enableGalaxy&&(pGalacticSystem=generateGalaxy(),translating.add(pGalacticSystem),enableDust&&(pDustSystem=generateDust(),pGalacticSystem.add(pDustSystem))),enableSolarSystem){var e=makeSolarSystem();translating.add(e)}enableSpacePlane&&(spacePlane=createSpacePlane(),translating.add(spacePlane)),enableSkybox&&initSkybox(!1)}function animate(){if(document.body.scrollTop=document.body.scrollLeft=0,camera.update(),camera.markersVisible=camera.position.z<markerThreshold.max&&camera.position.z>markerThreshold.min,lastRotateY=rotateY,!camera.__tour){rotateX+=rotateVX,rotateY+=rotateVY,rotateVX*=.9,rotateVY*=.9,dragging&&(rotateVX*=.6,rotateVY*=.6),initialAutoRotate&&(rotateVY=.0015);var e=100;translating.position.length()<1e-4&&(e=2),camera.position.z<e?(starModel&&(starModel.rotation.x=rotateX,starModel.rotation.y=rotateY),rotating.rotation.x=0,rotating.rotation.y=0):(rotating.rotation.x=rotateX,rotating.rotation.y=rotateY,starModel&&(starModel.rotation.x=rotateX,starModel.rotation.y=rotateY));var t=camera.position.target.z<markerThreshold.min,a=camera.position.target.z>markerThreshold.min;t&&camera.position.z<markerThreshold.min&&"none"==$detailContainer.css("display")&&"none"==$starName.css("display")?$starName.fadeIn():!a&&"none"==$detailContainer.css("display")||1!=$starName.css("opacity")||$starName.fadeOut(),t&&"none"!=$cssContainer.css("display")?$cssContainer.css({display:"none"}):t||"none"!=$cssContainer.css("display")||$cssContainer.css({display:"block"}),a&&"none"!=$detailContainer.css("display")&&!$detailContainer.hasClass("about")&&$detailContainer.fadeOut(),"none"==$detailContainer.css("display")?camera.position.x*=.95:camera.position.x+=.95*(camera.position.target.x-camera.position.x)}var n=constrain(Math.pow(camera.position.z,2)/1e5,1e-6,40);camera.fov=n,fovValue=.5/Math.tan(camera.fov*Math.PI/360)*screenHeight,camera.updateProjectionMatrix(),shaderTiming=(Date.now()-startTime)/1e3,rotateYAccumulate+=5*Math.abs(rotateY-lastRotateY),rotating.traverse(function(e){void 0!==e.update&&e.update()}),enableSkybox&&updateSkybox(),render(),setCSSWorld(),setCSSCamera(camera,fovValue),updateMarkers(),updateLegacyMarkers(),requestAnimationFrame(animate),(tour.touring||camera.easeZooming||translating.easePanning)&&(updateMinimap(),TWEEN.update())}function render(){renderer.clear(),enableSkybox&&renderSkybox(),renderer.render(scene,camera)}function muteSound(){document.getElementById("bgmusicA").volume=0,document.getElementById("bgmusicB").volume=0,localStorage&&localStorage.setItem("sound",0)}function unmuteSound(){document.getElementById("bgmusicA").volume=1,document.getElementById("bgmusicB").volume=1,localStorage&&localStorage.setItem("sound",1)}function displayIntroMessage(){Tour.meta.fadeIn(),tour.showMessage("Welcome to the stellar neighborhood.",5e3).showMessage("This is a visualization of over 100,000 nearby stars.",5e3).showMessage("Scroll and zoom to explore.",4e3,function(){firstTime=!1,$(window).trigger("resize"),$iconNav.find("#tour-button").trigger("mouseover")}).endMessages()}